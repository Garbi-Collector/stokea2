<div class="historial-container">
  <!-- Header -->
  <div class="page-header fade-in">
    <h1 class="page-title">Historial de Movimientos</h1>
    <p class="page-subtitle">Consulta todos los movimientos de caja registrados</p>
  </div>

  <!-- Barra de filtros -->
  <div class="filters-bar fade-in">
    <!-- Búsqueda -->
    <div class="search-box">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por descripción..."
        [(ngModel)]="filters.searchText"
        (input)="applyFilters()"
      >
      <button
        *ngIf="filters.searchText"
        class="clear-search"
        (click)="filters.searchText = ''; applyFilters()"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Botones de acción -->
    <div class="filter-actions">
      <button class="edit-button" (click)="showFilters = !showFilters">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
        </svg>
        <span>{{ showFilters ? 'Ocultar' : 'Filtros' }}</span>
      </button>
      <button class="refresh-button" (click)="loadAllData()" [disabled]="isLoading">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" [class.spinning]="isLoading">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        <span>Actualizar</span>
      </button>
    </div>
  </div>

  <!-- Panel de filtros avanzados -->
  <div class="advanced-filters fade-in-scale" *ngIf="showFilters">
    <div class="filters-grid">
      <!-- Fecha desde -->
      <div class="filter-group">
        <label class="select-label">Fecha desde</label>
        <input
          type="date"
          class="search-input"
          [(ngModel)]="filters.dateFrom"
          (change)="applyFilters()"
        >
      </div>

      <!-- Hora desde -->
      <div class="filter-group">
        <label class="select-label">Hora desde</label>
        <input
          type="time"
          class="search-input"
          [(ngModel)]="filters.timeFrom"
          (change)="applyFilters()"
          [disabled]="!filters.dateFrom"
        >
      </div>

      <!-- Fecha hasta -->
      <div class="filter-group">
        <label class="select-label">Fecha hasta</label>
        <input
          type="date"
          class="search-input"
          [(ngModel)]="filters.dateTo"
          (change)="applyFilters()"
        >
      </div>

      <!-- Hora hasta -->
      <div class="filter-group">
        <label class="select-label">Hora hasta</label>
        <input
          type="time"
          class="search-input"
          [(ngModel)]="filters.timeTo"
          (change)="applyFilters()"
          [disabled]="!filters.dateTo"
        >
      </div>

      <!-- Monto mínimo -->
      <div class="filter-group">
        <label class="select-label">Monto mínimo</label>
        <input
          type="number"
          class="search-input"
          placeholder="$0"
          [(ngModel)]="filters.amountMin"
          (input)="applyFilters()"
        >
      </div>

      <!-- Monto máximo -->
      <div class="filter-group">
        <label class="select-label">Monto máximo</label>
        <input
          type="number"
          class="search-input"
          placeholder="Sin límite"
          [(ngModel)]="filters.amountMax"
          (input)="applyFilters()"
        >
      </div>

      <!-- Tipo de movimiento -->
      <div class="filter-group">
        <label class="select-label">Tipo de movimiento</label>
        <select
          class="sort-select"
          [(ngModel)]="filters.type"
          (change)="applyFilters()"
        >
          <option value="ALL">Todos</option>
          <option value="IN">Entradas</option>
          <option value="OUT">Salidas</option>
          <option value="SALE">Ventas</option>
        </select>
      </div>

      <!-- Botón limpiar -->
      <div class="filter-group">
        <label class="select-label">&nbsp;</label>
        <button class="delete-button" (click)="clearFilters()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          <span>Limpiar filtros</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Sticky header de día -->
  <div class="sticky-day-header" *ngIf="currentStickyDay && filteredDayGroups.length > 0">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
    {{ currentStickyDay }}
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando movimientos...</p>
  </div>

  <!-- Lista de movimientos agrupados por día -->
  <div class="movements-list" *ngIf="!isLoading">
    <div
      *ngFor="let group of filteredDayGroups"
      class="day-group fade-in"
      [id]="'day-' + group.dateString"
    >
      <!-- Separador de día -->
      <div class="day-separator">
        <div class="day-header">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <h2>{{ group.dayLabel }}</h2>
        </div>
        <div class="day-summary">
          <div class="summary-item success">
            <span class="summary-label">Entradas</span>
            <span class="summary-amount">{{ formatCurrency(group.totalIn) }}</span>
          </div>
          <div class="summary-item danger">
            <span class="summary-label">Salidas</span>
            <span class="summary-amount">{{ formatCurrency(group.totalOut) }}</span>
          </div>
          <div class="summary-item primary">
            <span class="summary-label">Ventas</span>
            <span class="summary-amount">{{ formatCurrency(group.totalSale) }}</span>
          </div>
        </div>
      </div>

      <!-- Movimientos del día -->
      <div class="movements-grid">
        <div
          *ngFor="let movement of group.movements"
          class="movement-card"
          [ngClass]="getMovementClass(movement.type)"
        >
          <div class="movement-header">
            <div class="movement-title-section">
              <h3 class="movement-title">{{ getMovementTitle(movement.type) }}</h3>
              <p class="movement-amount">{{ formatCurrency(movement.amount) }}</p>
            </div>
            <div class="movement-time">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              {{ formatTime(movement.created_at!) }}
            </div>
          </div>

          <div class="movement-body" *ngIf="movement.description">
            <p class="movement-description">{{ movement.description }}</p>
          </div>

          <div class="movement-footer">
            <div class="session-info">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>Sesión #{{ movement.cash_session_id }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estado vacío -->
    <div class="empty-state" *ngIf="filteredDayGroups.length === 0">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <h3>No se encontraron movimientos</h3>
      <p>Intenta ajustar los filtros de búsqueda</p>
    </div>
  </div>
</div>
